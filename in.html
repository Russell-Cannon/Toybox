<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Toybox</title>
    <style>
      html,
      body,
      canvas {
        height: 100%;
        margin: 0;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        background-color: red;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script>
      const canvas = document.getElementById("canvas");
      const gl = canvas.getContext("webgl2");
      if (!gl) {
        document.body.textContent = "WebGL2 required";
        throw 0;
      }

      let textureId = 0;
      function createTexture(filepath) {
        // Create a texture.
        var texture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, texture);

        // Fill the texture with a 1x1 blue pixel.
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 255, 255]));

        // Asynchronously load an image
        var image = new Image();
        image.src = filepath;
        image.addEventListener("load", function () {
          // Now that the image has loaded make copy it to the texture.
          gl.activeTexture(gl.TEXTURE0 + textureId);
          textureId++;
          gl.bindTexture(gl.TEXTURE_2D, texture);
          gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
          gl.generateMipmap(gl.TEXTURE_2D);
        });
      }

$$texture$

      const vs = `#version 300 es
            const vec2 verts[3] = vec2[3](vec2(-1.0,-1.0), vec2(3.0,-1.0), vec2(-1.0,3.0));
            void main() {
                gl_Position = vec4(verts[gl_VertexID], 0.0, 1.0);
            }`;

      const fs = `#version 300 es
            precision highp float;
            #define PI 3.14159265359
            #define TWO_PI 6.28318530718
            uniform vec2 iResolution;
            uniform float time;
            uniform sampler2D u_texture0;
            uniform sampler2D u_texture1;
            uniform sampler2D u_texture2;
            uniform sampler2D u_texture3;
            uniform sampler2D u_texture4;
            uniform sampler2D u_texture5;
            uniform sampler2D u_texture6;
            uniform sampler2D u_texture7;
            out vec4 outColor;

            //credit https://www.shadertoy.com/view/4djSRW for hash function
            float hash(vec2 st) { return fract(sin(dot(st, vec2(12.9898, 78.233))) * 43758.5453); }

            //credit https://github.com/stegu/webgl-noise for simplex noise function
            vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
            vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
            vec3 permute(vec3 x) { return mod289(((x*34.0)+10.0)*x); }
            float snoise(vec2 v) { const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626,0.024390243902439);  vec2 i  = floor(v + dot(v, C.yy) ); vec2 x0 = v -   i + dot(i, C.xx); vec2 i1; i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0); vec4 x12 = x0.xyxy + C.xxzz; x12.xy -= i1; i = mod289(i); vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 )) + i.x + vec3(0.0, i1.x, 1.0 )); vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0); m = m*m ; m = m*m ; vec3 x = 2.0 * fract(p * C.www) - 1.0; vec3 h = abs(x) - 0.5; vec3 ox = floor(x + 0.5); vec3 a0 = x - ox; m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h ); vec3 g; g.x  = a0.x  * x0.x  + h.x  * x0.y; g.yz = a0.yz * x12.xz + h.yz * x12.yw; return 130.0 * dot(m, g); }

            void main() {$$output$}`;

      function compile(type, src) {
        const s = gl.createShader(type);
        gl.shaderSource(s, src);
        gl.compileShader(s);
        if (!gl.getShaderParameter(s, gl.COMPILE_STATUS))
          throw gl.getShaderInfoLog(s);
        return s;
      }

      const prog = gl.createProgram();
      gl.attachShader(prog, compile(gl.VERTEX_SHADER, vs));
      gl.attachShader(prog, compile(gl.FRAGMENT_SHADER, fs));
      gl.linkProgram(prog);
      if (!gl.getProgramParameter(prog, gl.LINK_STATUS))
        throw gl.getProgramInfoLog(prog);
      gl.useProgram(prog);

      const iResolutionLoc = gl.getUniformLocation(prog, "iResolution");
      const iTimeLoc = gl.getUniformLocation(prog, "time");

      for (let i = 0; i < 8; i++) {
        let iTextureLoc = gl.getUniformLocation(prog, "u_texture" + String(i));
        gl.uniform1i(iTextureLoc, i);
      }

      let start = performance.now();
      render();
      function render() {
        const t = (performance.now() - start) * 0.001;
        gl.uniform1f(iTimeLoc, t);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
        requestAnimationFrame(render);
      }

      function resize() {
        const dpr = window.devicePixelRatio || 1;
        const w = Math.floor(canvas.clientWidth * dpr);
        const h = Math.floor(canvas.clientHeight * dpr);
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w;
          canvas.height = h;
          gl.viewport(0, 0, w, h);
        }
        gl.uniform2f(iResolutionLoc, canvas.width, canvas.height);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
      }

      window.addEventListener("resize", resize);
      resize();
    </script>
  </body>
</html>
